<head>
    <title>TF.js Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js" integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
</head>

<body>
    <img id="train_img" src="../static/img/apples/train/rotten/vertical_flip_Screen Shot 2018-06-08 at 2.26.14 PM.png"></img>
    <img id="test_img" src="../static/img/apples/test/fresh/translation_Screen Shot 2018-06-08 at 5.22.35 PM.png"></img>
    <p id="results"></p>
    <button id="upload_btn">Upload Model</button>

    <script>
        // Global variables
        let mobilenet = undefined;
        let model = undefined;
    
        // Constants
        const IMAGE_WIDTH = 224;
        const IMAGE_HEIGHT = 224;
        const MODEL_URL = 'https://tfhub.dev/google/tfjs-model/imagenet/mobilenet_v3_small_100_224/feature_vector/5/default/1';
        const CLASS_NAMES = ['Fresh', 'Rotten'];
        const train_img = document.getElementById('train_img');
        const test_img = document.getElementById('test_img');
        const results_txt = document.getElementById('results');
    
        // Temporary
        const training_data_files = ['../static/img/apples/train/fresh/Screen Shot 2018-06-08 at 5.24.12 PM.png', '../static/img/apples/train/fresh/a_f150.png', '../static/img/apples/train/fresh/a_f144.png', '../static/img/apples/train/fresh/translation_Screen Shot 2018-06-08 at 5.04.24 PM.png', '../static/img/apples/train/fresh/rotated_by_30_Screen Shot 2018-06-08 at 5.13.18 PM.png', '../static/img/apples/train/fresh/Screen Shot 2018-06-08 at 5.02.43 PM.png', '../static/img/apples/train/fresh/a_f622.png', '../static/img/apples/train/fresh/saltandpepper_Screen Shot 2018-06-08 at 5.10.11 PM.png', '../static/img/apples/train/fresh/a_f178.png', '../static/img/apples/train/fresh/rotated_by_15_Screen Shot 2018-06-08 at 5.28.48 PM.png', '../static/img/apples/train/fresh/rotated_by_15_Screen Shot 2018-06-08 at 5.09.03 PM.png', '../static/img/apples/train/fresh/translation_Screen Shot 2018-06-08 at 5.04.59 PM.png', '../static/img/apples/train/fresh/a_f187.png', '../static/img/apples/train/fresh/rotated_by_45_Screen Shot 2018-06-08 at 5.02.38 PM.png', '../static/img/apples/train/fresh/rotated_by_45_Screen Shot 2018-06-08 at 5.20.42 PM.png', '../static/img/apples/train/fresh/rotated_by_45_Screen Shot 2018-06-08 at 5.16.49 PM.png', '../static/img/apples/train/fresh/rotated_by_30_Screen Shot 2018-06-08 at 5.10.29 PM.png', '../static/img/apples/train/fresh/translation_Screen Shot 2018-06-08 at 5.21.44 PM.png', '../static/img/apples/train/fresh/a_f352.png', '../static/img/apples/train/fresh/rotated_by_15_Screen Shot 2018-06-08 at 5.15.14 PM.png', '../static/img/apples/train/fresh/rotated_by_30_Screen Shot 2018-06-08 at 5.26.41 PM.png', '../static/img/apples/train/fresh/rotated_by_60_Screen Shot 2018-06-08 at 5.07.05 PM.png', '../static/img/apples/train/fresh/a_f434.png', '../static/img/apples/train/fresh/a_f420.png', '../static/img/apples/train/fresh/rotated_by_15_Screen Shot 2018-06-08 at 5.27.34 PM.png', '../static/img/apples/train/fresh/a_f346.png', '../static/img/apples/train/fresh/rotated_by_45_Screen Shot 2018-06-08 at 5.28.24 PM.png', '../static/img/apples/train/fresh/a_f408.png', '../static/img/apples/train/fresh/rotated_by_75_Screen Shot 2018-06-08 at 5.01.08 PM.png', '../static/img/apples/train/fresh/saltandpepper_Screen Shot 2018-06-08 at 5.07.32 PM.png', '../static/img/apples/train/fresh/vertical_flip_Screen Shot 2018-06-08 at 5.00.26 PM.png', '../static/img/apples/train/fresh/rotated_by_30_Screen Shot 2018-06-08 at 5.10.37 PM.png', '../static/img/apples/train/fresh/rotated_by_45_Screen Shot 2018-06-08 at 5.16.57 PM.png', '../static/img/apples/train/fresh/a_f391.png', '../static/img/apples/train/fresh/rotated_by_45_Screen Shot 2018-06-08 at 5.19.35 PM.png', '../static/img/apples/train/fresh/vertical_flip_Screen Shot 2018-06-08 at 5.03.17 PM.png', '../static/img/apples/train/fresh/rotated_by_60_Screen Shot 2018-06-08 at 5.17.22 PM.png', '../static/img/apples/train/fresh/a_f385.png', '../static/img/apples/train/fresh/rotated_by_15_Screen Shot 2018-06-08 at 5.27.49 PM.png', '../static/img/apples/train/fresh/rotated_by_75_Screen Shot 2018-06-08 at 5.33.55 PM.png', '../static/img/apples/train/fresh/rotated_by_15_Screen Shot 2018-06-08 at 5.02.54 PM.png', '../static/img/apples/train/fresh/rotated_by_15_Screen Shot 2018-06-08 at 5.19.47 PM.png', '../static/img/apples/train/fresh/a_f226.png', '../static/img/apples/train/fresh/a_f554.png', '../static/img/apples/train/fresh/a_f232.png', '../static/img/apples/train/fresh/vertical_flip_Screen Shot 2018-06-08 at 5.25.37 PM.png', '../static/img/apples/train/fresh/rotated_by_75_Screen Shot 2018-06-08 at 5.20.32 PM.png', '../static/img/apples/train/fresh/rotated_by_75_Screen Shot 2018-06-08 at 5.02.48 PM.png', '../static/img/apples/train/fresh/translation_Screen Shot 2018-06-08 at 5.18.42 PM.png', '../static/img/apples/train/fresh/saltandpepper_Screen Shot 2018-06-08 at 5.10.03 PM.png', '../static/img/apples/train/rotten/rotated_by_15_Screen Shot 2018-06-07 at 2.47.20 PM.png', '../static/img/apples/train/rotten/rotated_by_75_Screen Shot 2018-06-08 at 2.24.15 PM.png', '../static/img/apples/train/rotten/saltandpepper_Screen Shot 2018-06-08 at 2.47.09 PM.png', '../static/img/apples/train/rotten/a_r569.png', '../static/img/apples/train/rotten/translation_Screen Shot 2018-06-07 at 2.45.18 PM.png', '../static/img/apples/train/rotten/rotated_by_60_Screen Shot 2018-06-08 at 2.35.25 PM.png', '../static/img/apples/train/rotten/saltandpepper_Screen Shot 2018-06-07 at 3.00.56 PM.png', '../static/img/apples/train/rotten/Screen Shot 2018-06-07 at 2.18.57 PM.png', '../static/img/apples/train/rotten/a_r227.png', '../static/img/apples/train/rotten/a_r541.png', '../static/img/apples/train/rotten/rotated_by_75_Screen Shot 2018-06-08 at 2.37.03 PM.png', '../static/img/apples/train/rotten/a_r555.png', '../static/img/apples/train/rotten/rotated_by_30_Screen Shot 2018-06-07 at 2.41.32 PM.png', '../static/img/apples/train/rotten/rotated_by_60_Screen Shot 2018-06-08 at 2.32.42 PM.png', '../static/img/apples/train/rotten/vertical_flip_Screen Shot 2018-06-07 at 3.00.25 PM.png', '../static/img/apples/train/rotten/rotated_by_75_Screen Shot 2018-06-08 at 2.33.28 PM.png', '../static/img/apples/train/rotten/a_r233.png', '../static/img/apples/train/rotten/rotated_by_15_Screen Shot 2018-06-08 at 2.37.13 PM.png', '../static/img/apples/train/rotten/rotated_by_75_Screen Shot 2018-06-07 at 3.06.11 PM.png', '../static/img/apples/train/rotten/rotated_by_45_Screen Shot 2018-06-07 at 2.40.48 PM.png', '../static/img/apples/train/rotten/saltandpepper_Screen Shot 2018-06-08 at 2.36.23 PM.png', '../static/img/apples/train/rotten/rotated_by_15_Screen Shot 2018-06-08 at 2.46.44 PM.png', '../static/img/apples/train/rotten/rotated_by_45_Screen Shot 2018-06-07 at 2.58.17 PM.png', '../static/img/apples/train/rotten/saltandpepper_Screen Shot 2018-06-08 at 2.40.13 PM.png', '../static/img/apples/train/rotten/a_r582.png', '../static/img/apples/train/rotten/rotated_by_30_Screen Shot 2018-06-08 at 2.40.56 PM.png', '../static/img/apples/train/rotten/saltandpepper_Screen Shot 2018-06-08 at 2.50.49 PM.png', '../static/img/apples/train/rotten/a_r596.png', '../static/img/apples/train/rotten/translation_Screen Shot 2018-06-08 at 2.48.52 PM.png', '../static/img/apples/train/rotten/translation_Screen Shot 2018-06-08 at 2.47.30 PM.png', '../static/img/apples/train/rotten/vertical_flip_Screen Shot 2018-06-07 at 3.04.10 PM.png', '../static/img/apples/train/rotten/a_r019.png', '../static/img/apples/train/rotten/vertical_flip_Screen Shot 2018-06-07 at 2.15.50 PM.png', '../static/img/apples/train/rotten/vertical_flip_Screen Shot 2018-06-08 at 2.39.51 PM.png', '../static/img/apples/train/rotten/a_r743.png', '../static/img/apples/train/rotten/saltandpepper_Screen Shot 2018-06-07 at 2.42.25 PM.png', '../static/img/apples/train/rotten/a_r025.png', '../static/img/apples/train/rotten/a_r031.png', '../static/img/apples/train/rotten/a_r757.png', '../static/img/apples/train/rotten/vertical_flip_Screen Shot 2018-06-07 at 2.59.38 PM.png', '../static/img/apples/train/rotten/vertical_flip_Screen Shot 2018-06-08 at 2.26.14 PM.png', '../static/img/apples/train/rotten/saltandpepper_Screen Shot 2018-06-07 at 2.41.14 PM.png', '../static/img/apples/train/rotten/rotated_by_60_Screen Shot 2018-06-07 at 2.55.52 PM.png', '../static/img/apples/train/rotten/a_r780.png', '../static/img/apples/train/rotten/a_r794.png', '../static/img/apples/train/rotten/rotated_by_60_Screen Shot 2018-06-08 at 2.35.37 PM.png', '../static/img/apples/train/rotten/rotated_by_60_Screen Shot 2018-06-07 at 2.51.08 PM.png', '../static/img/apples/train/rotten/translation_Screen Shot 2018-06-08 at 2.40.38 PM.png', '../static/img/apples/train/rotten/vertical_flip_Screen Shot 2018-06-08 at 2.50.55 PM.png', '../static/img/apples/train/rotten/rotated_by_45_Screen Shot 2018-06-08 at 2.34.42 PM.png'];
        const test_data_files = ['../static/img/apples/test/fresh/rotated_by_30_Screen Shot 2018-06-08 at 5.18.51 PM.png', '../static/img/apples/test/fresh/a_f636.png', '../static/img/apples/test/fresh/a_f193.png', '../static/img/apples/test/fresh/rotated_by_75_Screen Shot 2018-06-08 at 5.11.52 PM.png', '../static/img/apples/test/fresh/rotated_by_60_Screen Shot 2018-06-08 at 5.25.02 PM.png', '../static/img/apples/test/fresh/rotated_by_45_Screen Shot 2018-06-08 at 5.28.59 PM.png', '../static/img/apples/test/fresh/rotated_by_45_Screen Shot 2018-06-08 at 5.05.41 PM.png', '../static/img/apples/test/fresh/a_f540.png', '../static/img/apples/test/fresh/rotated_by_45_Screen Shot 2018-06-08 at 5.11.41 PM.png', '../static/img/apples/test/fresh/rotated_by_75_Screen Shot 2018-06-08 at 5.16.44 PM.png', '../static/img/apples/test/fresh/rotated_by_45_Screen Shot 2018-06-08 at 5.34.21 PM.png', '../static/img/apples/test/fresh/a_f030.png', '../static/img/apples/test/fresh/rotated_by_30_Screen Shot 2018-06-08 at 5.29.31 PM.png', '../static/img/apples/test/fresh/rotated_by_15_Screen Shot 2018-06-08 at 5.19.28 PM.png', '../static/img/apples/test/fresh/rotated_by_75_Screen Shot 2018-06-08 at 5.33.47 PM.png', '../static/img/apples/test/fresh/translation_Screen Shot 2018-06-08 at 5.13.40 PM.png', '../static/img/apples/test/fresh/a_f019.png', '../static/img/apples/test/fresh/rotated_by_45_Screen Shot 2018-06-08 at 5.15.21 PM.png', '../static/img/apples/test/fresh/a_f025.png', '../static/img/apples/test/fresh/rotated_by_15_Screen Shot 2018-06-08 at 5.12.34 PM.png', '../static/img/apples/test/rotten/a_r059.png', '../static/img/apples/test/rotten/rotated_by_75_Screen Shot 2018-06-07 at 2.57.17 PM.png', '../static/img/apples/test/rotten/rotated_by_45_Screen Shot 2018-06-08 at 2.46.36 PM.png', '../static/img/apples/test/rotten/rotated_by_15_Screen Shot 2018-06-07 at 3.05.53 PM.png', '../static/img/apples/test/rotten/rotated_by_75_Screen Shot 2018-06-08 at 2.34.51 PM.png', '../static/img/apples/test/rotten/rotated_by_60_Screen Shot 2018-06-07 at 2.33.38 PM.png', '../static/img/apples/test/rotten/vertical_flip_Screen Shot 2018-06-07 at 3.00.46 PM.png', '../static/img/apples/test/rotten/saltandpepper_Screen Shot 2018-06-07 at 2.42.58 PM.png', '../static/img/apples/test/rotten/rotated_by_60_Screen Shot 2018-06-07 at 2.41.23 PM.png', '../static/img/apples/test/rotten/rotated_by_75_Screen Shot 2018-06-07 at 3.02.24 PM.png', '../static/img/apples/test/rotten/saltandpepper_Screen Shot 2018-06-07 at 2.23.24 PM.png', '../static/img/apples/test/rotten/a_r179.png', '../static/img/apples/test/rotten/a_r637.png', '../static/img/apples/test/rotten/Screen Shot 2018-06-08 at 2.49.40 PM.png', '../static/img/apples/test/rotten/a_r192.png', '../static/img/apples/test/rotten/translation_Screen Shot 2018-06-07 at 2.33.47 PM.png', '../static/img/apples/test/rotten/rotated_by_15_Screen Shot 2018-06-07 at 2.43.07 PM.png', '../static/img/apples/test/rotten/rotated_by_60_Screen Shot 2018-06-07 at 2.51.16 PM.png', '../static/img/apples/test/rotten/rotated_by_60_Screen Shot 2018-06-07 at 2.37.01 PM.png', '../static/img/apples/test/rotten/rotated_by_15_Screen Shot 2018-06-07 at 2.36.06 PM.png', '../static/img/apples/test/rotten/saltandpepper_Screen Shot 2018-06-07 at 2.19.37 PM.png', '../static/img/apples/test/rotten/rotten_banana.png', '../static/img/apples/test/fresh/fresh_potato.png'];
        
        // Array to store image features of training data
        const training_data = []; 
        // Array to store binary classification of training data
        const training_output = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1];
    
        // Async function to initiate in-browser machine learning
        async function start_ml() {
            // NOTE: Tidy function is used for automatic memory clean ups (clean up all intermediate tensors afterwards to avoid memory leaks)
            // dispose() to release the WebGL memory allocated for the return value of predict
    
            // Load pre-trained mobilenet model (image feature vectors) from TensorFlowHub
            mobilenet = await tf.loadGraphModel(MODEL_URL, { fromTFHub: true });
    
            tf.tidy(function() { 
                // Warm up the model by passing zeros through it once, to make first prediction faster
                mobilenet.predict(tf.zeros([1, IMAGE_HEIGHT, IMAGE_WIDTH, 3])).dispose();   // Tensor of 1 x 224px x 224px x 3 colour channels (RGB)
            });
    
            // Prepare training data
            for(let i = 0; i < training_data_files.length; i++) {
                // Update image (TEMPORARY)
                train_img.src = training_data_files[i];
                // Ensure image is loaded before moving on
                await new Promise((resolve) => train_img.onload = resolve);
    
                // Obtain image features
                let image_features = tf.tidy(function() {
                    // Create tensor from image
                    let test_tensor = tf.browser.fromPixels(train_img);
    
                    // Resize tensor (value of data is between 0-255) and ensure all values are between 0 and 1 (for inputs into mobilenet model)
                    test_tensor = tf.image.resizeBilinear(test_tensor, [IMAGE_HEIGHT, IMAGE_WIDTH], true).div(255);
    
                    // Get mobilenet's predicted outcome for the expanded rank tensor, and remove dimensions of 1 afterwards
                    return mobilenet.predict(test_tensor.expandDims()).squeeze();
                });
    
                // Append image feature into array of training data
                training_data.push(image_features);
            }
    
            // Create new model classification head (multilayer perceptron)
            model = tf.sequential();
            // Add intermediate layer with 1024 input nodes (output from mobilenet model), 128 output nodes, ReLU activation function
            model.add(tf.layers.dense({ inputShape: [1024], units: 128, activation: 'relu' })); 
            // Add output layer, with number of neurons equal to number of classification classes, Softmax activation function (for classification problem)
            model.add(tf.layers.dense({ units: CLASS_NAMES.length, activation: 'softmax' }));   
            // Get summary of model in console
            model.summary();
    
            // Compile model
            model.compile({
                // Adam changes the learning rate over time which is useful.
                optimizer: 'adam',
                // Use the correct loss function. If 2 classes of data, must use binaryCrossentropy.
                // Else categoricalCrossentropy is used if more than 2 classes.
                loss: (CLASS_NAMES.length === 2) ? 'binaryCrossentropy': 'categoricalCrossentropy', 
                // As this is a classification problem you can record accuracy in the logs too!
                metrics: ['accuracy']  
            });
            
            /* Model Training */
            // Shuffle training data
            tf.util.shuffleCombo(training_data, training_output);
            // Convert tensor array into a 1D tensor array
            let output_tensor = tf.tensor1d(training_output, 'int32');
            // Convert into a one-hot tensor array
            let onehot_output = tf.oneHot(output_tensor, CLASS_NAMES.length);
            // Convert array of tensors into a 2D tensor
            let input_tensor = tf.stack(training_data);
            
            // Train classification head
            await model.fit(input_tensor, onehot_output, {shuffle: true, batchSize: 5, epochs: 10, callbacks: { onEpochEnd: (epoch, log) => console.log(epoch, log)}});

            // Dispose temporary tensors to release the WebGL memory allocated
            output_tensor.dispose();
            onehot_output.dispose();
            input_tensor.dispose();
            
            /* Model Testing */
            for(let i = 0; i < test_data_files.length; i++) {
                // Update image (TEMPORARY)
                test_img.src = test_data_files[i];
                // Ensure image is loaded before moving on
                await new Promise((resolve) => test_img.onload = resolve);
    
                tf.tidy(function () {
                    // Create tensor from image
                    let test_tensor = tf.browser.fromPixels(test_img);

                    // Resize tensor (value of data is between 0-255) and ensure all values are between 0 and 1 (for inputs into mobilenet model)
                    test_tensor = tf.image.resizeBilinear(test_tensor, [IMAGE_HEIGHT, IMAGE_WIDTH], true).div(255);
                    
                    // Get mobilenet's interemediate predicted outcome for the expanded rank tensor
                    let test_image_features = mobilenet.predict(test_tensor.expandDims());

                    // Get classification head's predicted outcome, and remove dimensions of 1 afterwards
                    let prediction = model.predict(test_image_features).squeeze();

                    // Find index with highest value and convert tensor into an array
                    let highestIndex = prediction.argMax().arraySync();

                    // Get prediction scores as an array
                    let predictionArray = prediction.arraySync();

                    // Gwr prediction results
                    let prediction_txt = 'Prediction: ' + CLASS_NAMES[highestIndex] + ' with ' + predictionArray[highestIndex] * 100 + '% confidence'
    
                    // Update results
                    results_txt.innerText = prediction_txt;
                    console.log(prediction_txt)
                });
            }
    
        }
        
        // Define the onclick event handler function
        async function upload_btn_click() {
            alert("Button clicked!");
            const saveResult = await model.save('http://127.0.0.1:5000/upload_model');
        }

        // Attach the event handler to the button
        $("#upload_btn").on('click', upload_btn_click);

        // JS entrypoint
        $(document).ready(function() {
            // Invoke in-browser machine learning function
            start_ml();
        });
    
    </script>

</body>