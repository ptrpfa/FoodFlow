<!-- Import TensorFlow.js library -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>

<!-- Load the MobileNet model. -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@1.0.0"> </script>

<!-- Replace this with your image. Make sure CORS settings allow reading the image! -->
<img id="train_img" src="../static/img/apples/train/rotten/vertical_flip_Screen Shot 2018-06-08 at 2.26.14 PM.png"></img>
<img id="test_img" src="../static/img/apples/test/fresh/translation_Screen Shot 2018-06-08 at 5.22.35 PM.png"></img>

<!-- Place your code in the script tag below. You can also use an external .js file -->
<script>
    // Constants
    const IMAGE_WIDTH = 224;
    const IMAGE_HEIGHT = 224;
    const MODEL_URL = 'https://tfhub.dev/google/tfjs-model/imagenet/mobilenet_v3_small_100_224/feature_vector/5/default/1';
    const CLASS_NAMES = ['Fresh', 'Rotten'];
    const train_img = document.getElementById('train_img');
    const test_img = document.getElementById('test_img');

    // Temporary
    const training_data = []; // x
    const training_data_files = ['../static/img/apples/train/fresh/Screen Shot 2018-06-08 at 5.24.12 PM.png', '../static/img/apples/train/fresh/a_f150.png', '../static/img/apples/train/fresh/a_f144.png', '../static/img/apples/train/fresh/translation_Screen Shot 2018-06-08 at 5.04.24 PM.png', '../static/img/apples/train/fresh/rotated_by_30_Screen Shot 2018-06-08 at 5.13.18 PM.png', '../static/img/apples/train/fresh/Screen Shot 2018-06-08 at 5.02.43 PM.png', '../static/img/apples/train/fresh/a_f622.png', '../static/img/apples/train/fresh/saltandpepper_Screen Shot 2018-06-08 at 5.10.11 PM.png', '../static/img/apples/train/fresh/a_f178.png', '../static/img/apples/train/fresh/rotated_by_15_Screen Shot 2018-06-08 at 5.28.48 PM.png', '../static/img/apples/train/fresh/rotated_by_15_Screen Shot 2018-06-08 at 5.09.03 PM.png', '../static/img/apples/train/fresh/translation_Screen Shot 2018-06-08 at 5.04.59 PM.png', '../static/img/apples/train/fresh/a_f187.png', '../static/img/apples/train/fresh/rotated_by_45_Screen Shot 2018-06-08 at 5.02.38 PM.png', '../static/img/apples/train/fresh/rotated_by_45_Screen Shot 2018-06-08 at 5.20.42 PM.png', '../static/img/apples/train/fresh/rotated_by_45_Screen Shot 2018-06-08 at 5.16.49 PM.png', '../static/img/apples/train/fresh/rotated_by_30_Screen Shot 2018-06-08 at 5.10.29 PM.png', '../static/img/apples/train/fresh/translation_Screen Shot 2018-06-08 at 5.21.44 PM.png', '../static/img/apples/train/fresh/a_f352.png', '../static/img/apples/train/fresh/rotated_by_15_Screen Shot 2018-06-08 at 5.15.14 PM.png', '../static/img/apples/train/fresh/rotated_by_30_Screen Shot 2018-06-08 at 5.26.41 PM.png', '../static/img/apples/train/fresh/rotated_by_60_Screen Shot 2018-06-08 at 5.07.05 PM.png', '../static/img/apples/train/fresh/a_f434.png', '../static/img/apples/train/fresh/a_f420.png', '../static/img/apples/train/fresh/rotated_by_15_Screen Shot 2018-06-08 at 5.27.34 PM.png', '../static/img/apples/train/fresh/a_f346.png', '../static/img/apples/train/fresh/rotated_by_45_Screen Shot 2018-06-08 at 5.28.24 PM.png', '../static/img/apples/train/fresh/a_f408.png', '../static/img/apples/train/fresh/rotated_by_75_Screen Shot 2018-06-08 at 5.01.08 PM.png', '../static/img/apples/train/fresh/saltandpepper_Screen Shot 2018-06-08 at 5.07.32 PM.png', '../static/img/apples/train/fresh/vertical_flip_Screen Shot 2018-06-08 at 5.00.26 PM.png', '../static/img/apples/train/fresh/rotated_by_30_Screen Shot 2018-06-08 at 5.10.37 PM.png', '../static/img/apples/train/fresh/rotated_by_45_Screen Shot 2018-06-08 at 5.16.57 PM.png', '../static/img/apples/train/fresh/a_f391.png', '../static/img/apples/train/fresh/rotated_by_45_Screen Shot 2018-06-08 at 5.19.35 PM.png', '../static/img/apples/train/fresh/vertical_flip_Screen Shot 2018-06-08 at 5.03.17 PM.png', '../static/img/apples/train/fresh/rotated_by_60_Screen Shot 2018-06-08 at 5.17.22 PM.png', '../static/img/apples/train/fresh/a_f385.png', '../static/img/apples/train/fresh/rotated_by_15_Screen Shot 2018-06-08 at 5.27.49 PM.png', '../static/img/apples/train/fresh/rotated_by_75_Screen Shot 2018-06-08 at 5.33.55 PM.png', '../static/img/apples/train/fresh/rotated_by_15_Screen Shot 2018-06-08 at 5.02.54 PM.png', '../static/img/apples/train/fresh/rotated_by_15_Screen Shot 2018-06-08 at 5.19.47 PM.png', '../static/img/apples/train/fresh/a_f226.png', '../static/img/apples/train/fresh/a_f554.png', '../static/img/apples/train/fresh/a_f232.png', '../static/img/apples/train/fresh/vertical_flip_Screen Shot 2018-06-08 at 5.25.37 PM.png', '../static/img/apples/train/fresh/rotated_by_75_Screen Shot 2018-06-08 at 5.20.32 PM.png', '../static/img/apples/train/fresh/rotated_by_75_Screen Shot 2018-06-08 at 5.02.48 PM.png', '../static/img/apples/train/fresh/translation_Screen Shot 2018-06-08 at 5.18.42 PM.png', '../static/img/apples/train/fresh/saltandpepper_Screen Shot 2018-06-08 at 5.10.03 PM.png', '../static/img/apples/train/rotten/rotated_by_15_Screen Shot 2018-06-07 at 2.47.20 PM.png', '../static/img/apples/train/rotten/rotated_by_75_Screen Shot 2018-06-08 at 2.24.15 PM.png', '../static/img/apples/train/rotten/saltandpepper_Screen Shot 2018-06-08 at 2.47.09 PM.png', '../static/img/apples/train/rotten/a_r569.png', '../static/img/apples/train/rotten/translation_Screen Shot 2018-06-07 at 2.45.18 PM.png', '../static/img/apples/train/rotten/rotated_by_60_Screen Shot 2018-06-08 at 2.35.25 PM.png', '../static/img/apples/train/rotten/saltandpepper_Screen Shot 2018-06-07 at 3.00.56 PM.png', '../static/img/apples/train/rotten/Screen Shot 2018-06-07 at 2.18.57 PM.png', '../static/img/apples/train/rotten/a_r227.png', '../static/img/apples/train/rotten/a_r541.png', '../static/img/apples/train/rotten/rotated_by_75_Screen Shot 2018-06-08 at 2.37.03 PM.png', '../static/img/apples/train/rotten/a_r555.png', '../static/img/apples/train/rotten/rotated_by_30_Screen Shot 2018-06-07 at 2.41.32 PM.png', '../static/img/apples/train/rotten/rotated_by_60_Screen Shot 2018-06-08 at 2.32.42 PM.png', '../static/img/apples/train/rotten/vertical_flip_Screen Shot 2018-06-07 at 3.00.25 PM.png', '../static/img/apples/train/rotten/rotated_by_75_Screen Shot 2018-06-08 at 2.33.28 PM.png', '../static/img/apples/train/rotten/a_r233.png', '../static/img/apples/train/rotten/rotated_by_15_Screen Shot 2018-06-08 at 2.37.13 PM.png', '../static/img/apples/train/rotten/rotated_by_75_Screen Shot 2018-06-07 at 3.06.11 PM.png', '../static/img/apples/train/rotten/rotated_by_45_Screen Shot 2018-06-07 at 2.40.48 PM.png', '../static/img/apples/train/rotten/saltandpepper_Screen Shot 2018-06-08 at 2.36.23 PM.png', '../static/img/apples/train/rotten/rotated_by_15_Screen Shot 2018-06-08 at 2.46.44 PM.png', '../static/img/apples/train/rotten/rotated_by_45_Screen Shot 2018-06-07 at 2.58.17 PM.png', '../static/img/apples/train/rotten/saltandpepper_Screen Shot 2018-06-08 at 2.40.13 PM.png', '../static/img/apples/train/rotten/a_r582.png', '../static/img/apples/train/rotten/rotated_by_30_Screen Shot 2018-06-08 at 2.40.56 PM.png', '../static/img/apples/train/rotten/saltandpepper_Screen Shot 2018-06-08 at 2.50.49 PM.png', '../static/img/apples/train/rotten/a_r596.png', '../static/img/apples/train/rotten/translation_Screen Shot 2018-06-08 at 2.48.52 PM.png', '../static/img/apples/train/rotten/translation_Screen Shot 2018-06-08 at 2.47.30 PM.png', '../static/img/apples/train/rotten/vertical_flip_Screen Shot 2018-06-07 at 3.04.10 PM.png', '../static/img/apples/train/rotten/a_r019.png', '../static/img/apples/train/rotten/vertical_flip_Screen Shot 2018-06-07 at 2.15.50 PM.png', '../static/img/apples/train/rotten/vertical_flip_Screen Shot 2018-06-08 at 2.39.51 PM.png', '../static/img/apples/train/rotten/a_r743.png', '../static/img/apples/train/rotten/saltandpepper_Screen Shot 2018-06-07 at 2.42.25 PM.png', '../static/img/apples/train/rotten/a_r025.png', '../static/img/apples/train/rotten/a_r031.png', '../static/img/apples/train/rotten/a_r757.png', '../static/img/apples/train/rotten/vertical_flip_Screen Shot 2018-06-07 at 2.59.38 PM.png', '../static/img/apples/train/rotten/vertical_flip_Screen Shot 2018-06-08 at 2.26.14 PM.png', '../static/img/apples/train/rotten/saltandpepper_Screen Shot 2018-06-07 at 2.41.14 PM.png', '../static/img/apples/train/rotten/rotated_by_60_Screen Shot 2018-06-07 at 2.55.52 PM.png', '../static/img/apples/train/rotten/a_r780.png', '../static/img/apples/train/rotten/a_r794.png', '../static/img/apples/train/rotten/rotated_by_60_Screen Shot 2018-06-08 at 2.35.37 PM.png', '../static/img/apples/train/rotten/rotated_by_60_Screen Shot 2018-06-07 at 2.51.08 PM.png', '../static/img/apples/train/rotten/translation_Screen Shot 2018-06-08 at 2.40.38 PM.png', '../static/img/apples/train/rotten/vertical_flip_Screen Shot 2018-06-08 at 2.50.55 PM.png', '../static/img/apples/train/rotten/rotated_by_45_Screen Shot 2018-06-08 at 2.34.42 PM.png'];
    // y
    const training_output = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1];
    const test_data_files = ['../static/img/apples/test/fresh/rotated_by_30_Screen Shot 2018-06-08 at 5.18.51 PM.png', '../static/img/apples/test/fresh/a_f636.png', '../static/img/apples/test/fresh/a_f193.png', '../static/img/apples/test/fresh/rotated_by_75_Screen Shot 2018-06-08 at 5.11.52 PM.png', '../static/img/apples/test/fresh/rotated_by_60_Screen Shot 2018-06-08 at 5.25.02 PM.png', '../static/img/apples/test/fresh/rotated_by_45_Screen Shot 2018-06-08 at 5.28.59 PM.png', '../static/img/apples/test/fresh/rotated_by_45_Screen Shot 2018-06-08 at 5.05.41 PM.png', '../static/img/apples/test/fresh/a_f540.png', '../static/img/apples/test/fresh/rotated_by_45_Screen Shot 2018-06-08 at 5.11.41 PM.png', '../static/img/apples/test/fresh/rotated_by_75_Screen Shot 2018-06-08 at 5.16.44 PM.png', '../static/img/apples/test/fresh/rotated_by_45_Screen Shot 2018-06-08 at 5.34.21 PM.png', '../static/img/apples/test/fresh/a_f030.png', '../static/img/apples/test/fresh/rotated_by_30_Screen Shot 2018-06-08 at 5.29.31 PM.png', '../static/img/apples/test/fresh/rotated_by_15_Screen Shot 2018-06-08 at 5.19.28 PM.png', '../static/img/apples/test/fresh/rotated_by_75_Screen Shot 2018-06-08 at 5.33.47 PM.png', '../static/img/apples/test/fresh/translation_Screen Shot 2018-06-08 at 5.13.40 PM.png', '../static/img/apples/test/fresh/a_f019.png', '../static/img/apples/test/fresh/rotated_by_45_Screen Shot 2018-06-08 at 5.15.21 PM.png', '../static/img/apples/test/fresh/a_f025.png', '../static/img/apples/test/fresh/rotated_by_15_Screen Shot 2018-06-08 at 5.12.34 PM.png'];

    let mobilenet = undefined;

    function logProgress(epoch, logs) {
        console.log('Data for epoch ' + epoch, logs);
    }

    // Async function to load mobilenet model
    async function load_mobilenet() {
        // Load pre-trained mobilenet model
        mobilenet = await tf.loadGraphModel(MODEL_URL, { fromTFHub: true });

        // Tidy function used to clean up all intermediate tensors afterwards, to avoid memory leaks (automatic memory cleanup)
        tf.tidy(function() {
            // Warm up the model by passing zeros through it once, to make first prediction faster. Call dispose() to release the WebGL memory allocated for the return value of predict
            mobilenet.predict(tf.zeros([1, IMAGE_HEIGHT, IMAGE_WIDTH, 3])).dispose();   // Tensor of 1 x 224px x 224px x 3 channels (RGB)
        });

        // Prepare training data
        for(let i = 0; i < training_data_files.length; i++) {
            let imageFeatures = tf.tidy(function() {
                // Update image
                train_img.src = training_data_files[i];
                // Create tensor from image
                let current_tensor = tf.browser.fromPixels(train_img);
                // Resize and normalise tensor
                let resized_tensor = tf.image.resizeBilinear(current_tensor, [IMAGE_HEIGHT, IMAGE_WIDTH], true);
                let normalised_tensor = resized_tensor.div(255);
                // Get mobilenet's predicted outcome for the tensor
                return mobilenet.predict(normalised_tensor.expandDims()).squeeze();
            });
            training_data.push(imageFeatures);
        }
        console.log(training_data);

        // Create model
        let model = tf.sequential();
        model.add(tf.layers.dense({ inputShape: [1024], units: 128, activation: 'relu' }));
        model.add(tf.layers.dense({ units: CLASS_NAMES.length, activation: 'softmax' }));
        model.summary();

        // Compile the model with the defined optimizer and specify a loss function to use.
        model.compile({
            // Adam changes the learning rate over time which is useful.
            optimizer: 'adam',
            // Use the correct loss function. If 2 classes of data, must use binaryCrossentropy.
            // Else categoricalCrossentropy is used if more than 2 classes.
            loss: (CLASS_NAMES.length === 2) ? 'binaryCrossentropy': 'categoricalCrossentropy', 
            // As this is a classification problem you can record accuracy in the logs too!
            metrics: ['accuracy']  
        });

        // Train model
        tf.util.shuffleCombo(training_data, training_output);
        // Create tensor from y values
        let output_tensor = tf.tensor1d(training_output, 'int32');
        // Convert into a one-hot tensor
        let onehot_output = tf.oneHot(output_tensor, CLASS_NAMES.length);
        // Stack tensors into a one-rank tensor
        let input_tensor = tf.stack(training_data);

        let results = await model.fit(input_tensor, onehot_output, {shuffle: true, batchSize: 5, epochs: 10, callbacks: { onEpochEnd: logProgress }});

        // Dispose to release the WebGL memory allocated for the tensors
        output_tensor.dispose();
        onehot_output.dispose();
        input_tensor.dispose();
        
        // Test model
        for(let i = 0; i < test_data_files.length; i++) {
            // Update image
            test_img.src = test_data_files[i];
            tf.tidy(function () {
                // Create tensor from image
                let current_tensor = tf.browser.fromPixels(test_img).div(255);
                let resized_tensor = tf.image.resizeBilinear(current_tensor, [IMAGE_HEIGHT, IMAGE_WIDTH], true);
    
                let imageFeatures = mobilenet.predict(resized_tensor.expandDims());
                let prediction = model.predict(imageFeatures).squeeze();
                console.log("Prediction:", prediction);
                let highestIndex = prediction.argMax().arraySync();
                console.log("Highest Index:", highestIndex);
                let predictionArray = prediction.arraySync();
                console.log("Prediction Array:", predictionArray);
                console.log('Prediction: ' + CLASS_NAMES[highestIndex] + ' with ' + Math.floor(predictionArray[highestIndex] * 100) + '% confidence');
            });
        }

    }

    load_mobilenet();

</script>